<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0E2356">
    <title>AgentFlow - AI Chat Interface</title>

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Mermaid for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="./static/css/styles.css">

    <!-- Configuration -->
    <script>
        // API server running on localhost:4000
        window.AGENTFLOW_BASE_URL = 'http://localhost:4000';
    </script>
</head>
<body>
    <!-- Main Container -->
    <div class="app-container">
        <!-- Side Menu -->
        <aside id="side-menu" class="side-menu">
            <div class="menu-header">
                <h2>AgentFlow</h2>
                <div class="dropdown-container">
                    <button id="settings-btn" class="icon-btn-small" title="Settings">
                        <span class="material-icons">settings</span>
                    </button>
                    <div id="settings-dropdown" class="dropdown hidden">
                        <div class="dropdown-list">
                            <div class="dropdown-item" id="export-dropdown-btn">
                                <span class="material-icons">file_download</span>
                                Export Conversation
                            </div>
                            <div class="dropdown-item" id="export-gdocs-btn">
                                <span class="material-icons">description</span>
                                Export to Google Docs
                            </div>
                            <div class="dropdown-item" id="import-dropdown-btn">
                                <span class="material-icons">file_upload</span>
                                Import Conversation
                            </div>
                        </div>
                    </div>
                </div>
                <input type="file" id="import-input" accept=".json,.md,.txt" style="display: none;">
            </div>

            <!-- System Prompt Section -->
            <div class="menu-section system-prompt-section">
                <div class="section-header" id="system-prompt-header">
                    <h3>System Prompt</h3>
                    <button class="icon-btn-tiny" id="system-prompt-toggle" title="Toggle">
                        <span class="material-icons">expand_less</span>
                    </button>
                </div>
                <div id="system-prompt-content" class="collapsible-content">
                    <textarea id="system-prompt" rows="4" placeholder="Enter system prompt..."></textarea>
                </div>
            </div>

            <!-- Google Drive Sync Section -->
            <div class="menu-section">
                <h3>Google Drive</h3>
                <div id="gdrive-status" class="sync-status clickable">
                    <span class="status-indicator" id="sync-indicator"></span>
                    <span class="status-text" id="sync-status-text">Click to connect</span>
                    <span class="material-icons sync-action-icon" id="sync-action-icon">cloud_upload</span>
                </div>
            </div>

            <!-- Conversations List -->
            <div class="menu-section">
                <div class="conversations-header">
                    <h3>Conversations</h3>
                    <span id="conversation-count" class="conversation-count">0</span>
                </div>
                <div class="search-container">
                    <span class="material-icons search-icon">search</span>
                    <input type="text" id="conversation-search" class="conversation-search" placeholder="Search conversations...">
                    <button id="clear-search" class="icon-btn-clear hidden">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <div id="conversations-list" class="conversations-list"></div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="chat-header">
                <button id="menu-toggle" class="icon-btn">
                    <span class="material-icons">menu</span>
                </button>

                <button id="new-chat-btn" class="btn btn-primary">
                    <span class="material-icons">add</span>
                    New Chat
                </button>

                <div class="header-controls">
                    <!-- Model Selection -->
                    <div class="dropdown-container">
                        <button id="model-btn" class="btn btn-outline">
                            <span class="material-icons">smart_toy</span>
                            <span>Model</span>
                            <span class="material-icons">arrow_drop_down</span>
                        </button>
                        <div id="model-dropdown" class="dropdown hidden">
                            <div id="model-list" class="dropdown-list">
                                <div class="dropdown-item selected" data-model="gemini-2.0-flash">
                                    Gemini 2.0 Flash
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Audio Source Selection -->
                    <div class="dropdown-container">
                        <button id="audio-source-btn" class="btn btn-outline">
                            <span class="material-icons" id="audio-source-icon">mic</span>
                            <span id="audio-source-label">Microphone</span>
                            <span class="material-icons">arrow_drop_down</span>
                        </button>
                        <div id="audio-source-dropdown" class="dropdown audio-source-dropdown hidden">
                            <div class="dropdown-list">
                                <div class="dropdown-item audio-source-option selected" data-source="microphone">
                                    <span class="material-icons audio-source-item-icon">mic</span>
                                    <div class="audio-source-info">
                                        <span class="audio-source-title">Microphone</span>
                                        <span class="audio-source-desc">Capture your voice</span>
                                    </div>
                                    <span class="material-icons audio-source-check">check</span>
                                </div>
                                <div class="dropdown-item audio-source-option" data-source="system">
                                    <span class="material-icons audio-source-item-icon">volume_up</span>
                                    <div class="audio-source-info">
                                        <span class="audio-source-title">System Audio</span>
                                        <span class="audio-source-desc">Capture system sounds</span>
                                    </div>
                                    <span class="material-icons audio-source-check">check</span>
                                </div>
                                <div class="dropdown-item audio-source-option" data-source="mixed">
                                    <span class="material-icons audio-source-item-icon">settings_voice</span>
                                    <div class="audio-source-info">
                                        <span class="audio-source-title">Mic + System</span>
                                        <span class="audio-source-desc">Capture voice and sounds</span>
                                    </div>
                                    <span class="material-icons audio-source-check">check</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dark Mode Toggle -->
                    <button id="dark-mode-toggle" class="icon-btn" title="Toggle dark mode">
                        <span class="material-icons">dark_mode</span>
                    </button>
                </div>
            </header>

            <!-- Chat Messages -->
            <div id="chat-messages" class="chat-messages"></div>

            <!-- Recording Indicator -->
            <div id="recording-indicator" class="recording-indicator hidden">
                <div class="recording-animation">
                    <span class="recording-dot"></span>
                </div>
                <span id="recording-timer">00:00</span>
                <canvas id="audio-visualizer" class="audio-visualizer" width="200" height="40"></canvas>
            </div>

            <!-- File Preview -->
            <div id="file-preview" class="file-preview"></div>

            <!-- Markdown Toolbar -->
            <div id="markdown-toolbar" class="markdown-toolbar hidden">
                <button class="toolbar-btn" data-format="bold" title="Bold (Ctrl+B)">
                    <span class="material-icons">format_bold</span>
                </button>
                <button class="toolbar-btn" data-format="italic" title="Italic (Ctrl+I)">
                    <span class="material-icons">format_italic</span>
                </button>
                <button class="toolbar-btn" data-format="code" title="Code (Ctrl+`)">
                    <span class="material-icons">code</span>
                </button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" data-format="heading" title="Heading">
                    <span class="material-icons">title</span>
                </button>
                <button class="toolbar-btn" data-format="list" title="Bulleted list">
                    <span class="material-icons">format_list_bulleted</span>
                </button>
                <button class="toolbar-btn" data-format="numbered" title="Numbered list">
                    <span class="material-icons">format_list_numbered</span>
                </button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" data-format="quote" title="Quote">
                    <span class="material-icons">format_quote</span>
                </button>
                <button class="toolbar-btn" data-format="link" title="Link (Ctrl+K)">
                    <span class="material-icons">link</span>
                </button>
                <button class="toolbar-btn" data-format="codeblock" title="Code block">
                    <span class="material-icons">code_blocks</span>
                </button>
            </div>

            <!-- Slash Commands Dropdown -->
            <div id="slash-commands-dropdown" class="slash-commands-dropdown hidden">
                <div class="slash-commands-list" id="slash-commands-list">
                    <!-- Commands populated dynamically -->
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-row">
                    <!-- Recording Controls -->
                    <button id="record-btn" class="icon-btn" title="Start Recording">
                        <span class="material-icons">mic</span>
                    </button>
                    <button id="stop-record-btn" class="icon-btn hidden" title="Stop Recording">
                        <span class="material-icons">stop</span>
                    </button>
                    <button id="segment-btn" class="icon-btn hidden" title="Create Segment">
                        <span class="material-icons">fiber_manual_record</span>
                    </button>

                    <!-- File Attachment -->
                    <button id="attach-btn" class="icon-btn" title="Attach File">
                        <span class="material-icons">attach_file</span>
                    </button>
                    <input type="file" id="file-input" accept="image/*,application/pdf,audio/*" multiple style="display: none;">

                    <!-- Text Input -->
                    <textarea
                        id="user-input"
                        placeholder="Type your message..."
                        rows="1"
                    ></textarea>

                    <!-- Voice Input (Speech-to-Text) -->
                    <button id="voice-input-btn" class="icon-btn" title="Voice Input (Speech-to-Text)">
                        <span class="material-icons">keyboard_voice</span>
                    </button>

                    <!-- Templates -->
                    <div class="dropdown-container">
                        <button id="templates-btn" class="icon-btn" title="Prompt Templates">
                            <span class="material-icons">bookmark</span>
                        </button>
                        <div id="templates-dropdown" class="dropdown hidden">
                            <div class="dropdown-list" id="templates-list">
                                <!-- Templates populated dynamically -->
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-item" id="save-template-btn">
                                <span class="material-icons">add</span>
                                Save current as template
                            </div>
                            <div class="dropdown-item" id="manage-templates-btn">
                                <span class="material-icons">settings</span>
                                Manage templates
                            </div>
                        </div>
                    </div>

                    <!-- Send/Stop Buttons -->
                    <button id="send-btn" class="btn btn-primary">
                        <span class="material-icons">send</span>
                    </button>
                    <button id="stop-btn" class="btn btn-danger hidden">
                        <span class="material-icons">stop</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Notification Toast Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="keyboard-shortcuts-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Keyboard Shortcuts</h2>
                <button class="modal-close">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="shortcuts-grid">
                    <div class="shortcuts-section">
                        <h3>Navigation</h3>
                        <div class="shortcut-item">
                            <kbd>Cmd/Ctrl</kbd> + <kbd>B</kbd>
                            <span>Toggle side menu</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Cmd/Ctrl</kbd> + <kbd>K</kbd>
                            <span>Focus search</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Cmd/Ctrl</kbd> + <kbd>N</kbd>
                            <span>New chat</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Esc</kbd>
                            <span>Close dropdowns/menu</span>
                        </div>
                    </div>

                    <div class="shortcuts-section">
                        <h3>Messaging</h3>
                        <div class="shortcut-item">
                            <kbd>Enter</kbd>
                            <span>Send message</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Shift</kbd> + <kbd>Enter</kbd>
                            <span>New line</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Cmd/Ctrl</kbd> + <kbd>Enter</kbd>
                            <span>Save edit</span>
                        </div>
                    </div>

                    <div class="shortcuts-section">
                        <h3>Help</h3>
                        <div class="shortcut-item">
                            <kbd>?</kbd>
                            <span>Show this help</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="./static/js/config.js"></script>
    <script src="./static/js/googleDriveAuth.js"></script>
    <script src="./static/js/googleDriveStorage.js"></script>
    <script src="./static/js/storageManager.js"></script>
    <script src="./static/js/workerManager.js"></script>
    <script src="./static/js/chat.js"></script>
</body>
</html>
